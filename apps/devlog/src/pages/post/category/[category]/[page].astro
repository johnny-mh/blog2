---
import type { GetStaticPaths } from 'astro'

import { getPosts } from '#/collection'
import Pager from '#/components/Pager.astro'
import PostList from '#/components/PostList.astro'
import Layout from '#/layouts/Layout.astro'

export const getStaticPaths = (async ({ paginate }) => {
  const posts = await getPosts()

  const categories = [
    ...posts.reduce(
      (
        map,
        {
          path,
          readingTime,
          rendered: { remarkPluginFrontmatter: frontmatter },
        }
      ) => {
        frontmatter.categories?.forEach((cat: string) => {
          map.set(cat, [
            ...(map.get(cat) ?? []),
            { ...frontmatter, path, readingTime },
          ])
        })

        return map
      },
      new Map<string, Record<string, any>[]>()
    ),
  ]

  return categories
    .map(([category, list]) => {
      return paginate(list, {
        pageSize: 10,
        params: { category },
      })
    })
    .flatMap((arr) => arr)
}) satisfies GetStaticPaths

const { page } = Astro.props
const { category } = Astro.params
---

<Layout>
  <PostList list={page.data} title={`Category: ${category}`} />
  <Pager next={page.url.next} prev={page.url.prev} />
</Layout>
